<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
    <title>Web Vitals Leaderboard</title>
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        table-layout: fixed;
        border-collapse: collapse;
        margin: 0 auto;
        text-align: center;

        background-color: rgb(255,219,187);
        background: url('./flags.png'), linear-gradient(180deg, rgba(255,184,124,1) 0%, rgba(255,141,78,1) 35%, rgba(247,90,81,1) 100%);
        background-position: bottom;
        background-size: contain;
        background-repeat: no-repeat;
        min-height: 100vh;
      }

      abbr {
        text-decoration: none;
      }

      table {
        border-spacing: 0;
        border-collapse: collapse;
        border: 5px solid #444444;
        margin: 0 auto;
        width: 50%;
      }

      caption {
        padding: 5px;
      }

      tbody tr {
        background-color: #ffffff;
      }

      tbody tr:nth-child(even) {
        background-color: #f3f3f3;
      }

      th {
        background-color: #444444;
        color: #ffffff;
        font-size: 11px;
        text-transform: uppercase;
      }

      td {
        padding: 1rem 1rem 1rem 2rem;
        text-align: right;
        width: 50%;
      }

      .logo {
        border: 2px solid #f5f5f5;
        border-radius: 100%;
      }

      .rank-1 {
        font-size: 3em;
      }

      .rank-2 {
        font-size: 2.5em;
      }

      .rank-3 {
        font-size: 2em;
      }

      .good,
      .improvement,
      .poor {
        font-weight: bold;
      }

      .good {
        background-color: #b6d7a8;
      }
      .improvement {
        background-color: #ffe599;
      }
      .poor {
        background-color: #ea9999;
      }

      hr {
        width: 50%;
        margin: 20px auto;
        border: none;
        border-top: 1px solid #f5f5f5;
      }

    </style>
  </head>
  <body>
    <h1>Web Vitals Leaderboard</h1>
    <h2>Compare your speed against competitors</h2>
    <form>
      <label>URL
        <input id="url" type="url" name="url" />
      </label>
      <button id="add" type="submit" name="action" value="add">Add</button>
      <br/><br/>
      <button id="run" type="submit" name="action" value="run">üö•Run</button>
      <button id="reset" type="reset" name="action">üè≥Reset</button>
    </form>

    <hr/>

    <table>
      <thead>
        <tr>
          <th rowspan="2">Rank</th>
          <th rowspan="2">Logo</th>
          <th rowspan="2">Web Site</th>
          <th colspan="4" scope="col">Web Vitals</th>
        </tr>
        <tr>
          <th scope="col"><abbr title="First Contentful Paint">FCP</abbr></th>
          <th scope="col"><abbr title="Largest Contentful Paint">LCP</abbr></th>
          <th scope="col"><abbr title="First Input Delay">FID</abbr></th>
          <th scope="col"><abbr title="Cumulative Layout Shift">CLS</abbr></th>
        </tr>
      </thead>
      <tbody id="content"></tbody>
    </table>

    <hr/>

    <footer>
      <p><span class="heart">‚ù§Ô∏è</span>by <a href="https://twitter.com/pazguille" target="_blank" rel="noopener noreferrer">pazguille</a></p>
    </footer>

    <script>
      !function(){
        var lastBtn = null
        document.addEventListener('click',function(e){
            if (!e.target.closest) return;
            lastBtn = e.target.closest('button, input[type=submit]');
        }, true);
        document.addEventListener('submit', function(e){
            if ('submitter' in e) return;
            var canditates = [document.activeElement, lastBtn];
            for (var i=0; i < canditates.length; i++) {
                var candidate = canditates[i];
                if (!candidate) continue;
                if (!candidate.form) continue;
                if (!candidate.matches('button, input[type=button], input[type=image]')) continue;
                e.submitter = candidate;
                return;
            }
            e.submitter = e.target.querySelector('button, input[type=button], input[type=image]')
        }, true);
      }();

      function template(site, position) {
        const fcp = site.metrics.FCP && (site.metrics.FCP.percentiles.p75/1000).toFixed(2) || '';
        const lcp = site.metrics.LCP && (site.metrics.LCP.percentiles.p75/1000).toFixed(2) || '';
        const fid = site.metrics.FID && site.metrics.FID.percentiles.p75 || '';
        const cls = site.metrics.CLS && site.metrics.CLS.percentiles.p75 || '';

        return (`
<tr>
  <td class="rank-${position}">${positions[position-1]¬†|| position}</td>
  <td>${getLogo(site.origin ||¬†site.url)}</td>
  <td>${site.origin ||¬†site.url}</td>
  <td class="${healthy.FCP(fcp)}">${fcp}s</td>
  <td class="${healthy.LCP(lcp)}">${lcp}s</td>
  <td class="${healthy.FID(fid)}">${fid}ms</td>
  <td class="${healthy.CLS(cls)}">${cls}</td>
</tr>
`);
      }

      function getLogo(url) {
        return `<img class="logo" width="32" src="${`https://www.google.com/s2/favicons?sz=48&domain_url=${new URL(url).origin}/`}" alt="${url}"/>`
      }

      function skeletonTemplate(url) {
        return (`
<tr>
  <td class="rank">-</td>
  <td>${getLogo(url)}</td>
  <td>${url}</td>
  <td>0s</td>
  <td>0s</td>
  <td>0ms</td>
  <td>0</td>
</tr>
`);
      }

      const positions = ['ü•á', 'ü•à', 'ü•â'];
      const healthy = {
        FCP: (value) => value <= 1 ? 'good' : (value >= 2 ? 'poor' : 'improvement'),
        LCP: (value) => value <= 2.5 ? 'good' : (value >= 4 ? 'poor' : 'improvement'),
        FID: (value) => value <= 100 ? 'good' : (value >= 300 ? 'poor' : 'improvement'),
        CLS: (value) => value <= 0.1 ? 'good' : (value >= 0.25 ? 'poor' : 'improvement'),
      };

      function sortBy(metric) {
        return (a, b) => {
          if (a.metrics[metric].percentiles.p75 < b.metrics[metric].percentiles.p75) {
            return -1;
          }
          if (a.metrics[metric].percentiles.p75 > b.metrics[metric].percentiles.p75) {
            return 1;
          }
          return 0;
        }
      }

      const urls = [];
      const $input = document.querySelector('#url');
      const $reset = document.querySelector('#reset');
      const $form = document.querySelector('form');
      const $content = document.querySelector('#content');

      $form.addEventListener('submit', function(eve) {
        eve.preventDefault();
        if (eve.submitter.id === 'add') {
          urls.push($input.value);
          $content.insertAdjacentHTML('beforeend', skeletonTemplate($input.value));
        } else if (eve.submitter.id === 'run') {
          const data = urls.map((url) => encodeURIComponent(url)).join(',');
          fetch(`https://crux.pazguille.me/api/web-vitals?urls=${data}`)
            .then(res => res.json())
            .then((results) => {
              const html = results
                .sort(sortBy('LCP'))
                .map((result, index) => template(result, index+=1));
                $content.innerHTML = '';
                $content.insertAdjacentHTML('beforeend', html.join(''));
            });
        }
        $input.value = '';
      });

      $reset.addEventListener('click', () => {
        urls.length = 0;
        $content.innerHTML = '';
      });
    </script>
  </body>
</html>
